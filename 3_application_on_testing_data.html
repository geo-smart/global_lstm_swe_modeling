

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Tutorial 3: Evaluating the trained model on the test data &#8212; Use Case Template</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '3_application_on_testing_data';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tutorial 4: Running the model on downscaled climate projections" href="4_application_on_climate_projections.html" />
    <link rel="prev" title="Tutorial 2: Implementing the model and training pipeline" href="2_model_training.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="0_getting_started.html">
  
  
  
  
  
    <p class="title logo__title">Use Case Template</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">About</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference external" href="https://geo-smart.github.io/index.html">Geosmart Website</a></li>
<li class="toctree-l1"><a class="reference external" href="https://foundations.projectpythia.org/landing-page.html">Project Pythia Foundations</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter One</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="1_background_and_data.html">Tutorial 1: Background and data preparation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter Two</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="2_model_training.html">Tutorial 2: Implementing the model and training pipeline</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter Three</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Tutorial 3: Evaluating the trained model on the test data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapter Four</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="4_application_on_climate_projections.html">Tutorial 4: Running the model on downscaled climate projections</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/geo-smart/use_case_template/main?urlpath=lab/tree/book/3_application_on_testing_data.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/geo-smart/use_case_template" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/geo-smart/use_case_template/edit/main/book/3_application_on_testing_data.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/geo-smart/use_case_template/issues/new?title=Issue%20on%20page%20%2F3_application_on_testing_data.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/3_application_on_testing_data.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Tutorial 3: Evaluating the trained model on the test data</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outline">Outline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-and-configuration">Setup and configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-the-setup-from-our-saved-experiment">Loading the setup from our saved experiment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-plumbing-for-model-inference">Data plumbing for model inference</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-model-in-forward-inference-mode">Running the model in forward/inference mode</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#putting-the-data-back-together">Putting the data back together</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-to-the-analysis-and-quantifying-model-performance">Getting to the analysis and quantifying model performance</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="tutorial-3-evaluating-the-trained-model-on-the-test-data">
<h1>Tutorial 3: Evaluating the trained model on the test data<a class="headerlink" href="#tutorial-3-evaluating-the-trained-model-on-the-test-data" title="Permalink to this heading">#</a></h1>
<section id="outline">
<h2>Outline<a class="headerlink" href="#outline" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Imports, including library code from previous steps</p></li>
<li><p>Loading the trained model using hyperparameters and weights file</p></li>
<li><p>Setting up the datapipe for the test data</p></li>
<li><p>Some functions for “undoing/inverting” the ETL pipeline (aka recovering spatiotemporal relations)</p></li>
<li><p>Running the trained model in eval mode</p></li>
<li><p>Some basic metrics and analysis</p></li>
</ul>
</section>
<section id="setup-and-configuration">
<h2>Setup and configuration<a class="headerlink" href="#setup-and-configuration" title="Permalink to this heading">#</a></h2>
<p>As you might expect, we start with some standard imports. Here we will be also importing our ability to create LSTM based models and load experiments which fit our narrow focus via the <code class="docutils literal notranslate"><span class="pre">src.models</span></code> and <code class="docutils literal notranslate"><span class="pre">src.utils</span></code> modules which you can find included with the tutorial. Additionally we are using the <code class="docutils literal notranslate"><span class="pre">src.datapipes</span></code> module which comes from earlier as well. Finally, we set the device and data type as usual.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">tqdm.autonotebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">PowerNorm</span>
<span class="kn">from</span> <span class="nn">src.models</span> <span class="kn">import</span> <span class="n">create_lstm_model</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">load_experiment</span>
<span class="kn">from</span> <span class="nn">src.datapipes</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">make_data_pipeline</span><span class="p">,</span> <span class="n">merge_data</span><span class="p">,</span> <span class="n">select_region</span><span class="p">,</span>
    <span class="n">scale_means</span><span class="p">,</span> <span class="n">scale_stds</span>
<span class="p">)</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">DTYPE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/tmp/ipykernel_4285/2583463801.py:7: TqdmExperimentalWarning: Using `tqdm.autonotebook.tqdm` in notebook mode. Use `tqdm.tqdm` instead to force console mode (e.g. in jupyter console)
  from tqdm.autonotebook import tqdm
</pre></div>
</div>
</div>
</div>
</section>
<section id="loading-the-setup-from-our-saved-experiment">
<h2>Loading the setup from our saved experiment<a class="headerlink" href="#loading-the-setup-from-our-saved-experiment" title="Permalink to this heading">#</a></h2>
<p>With the defaults out of the way, we can prove how nice it is to have even some minimal MLOps infrastructure set up via the <code class="docutils literal notranslate"><span class="pre">save_experiment</span></code> and <code class="docutils literal notranslate"><span class="pre">load_experiment</span></code> functions by simply loading up the previously saved experiment. We then instantiate an equivalent model structure and load the trained model into it. We are then ready to start thinking about how we can apply this model to new data!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config_file</span> <span class="o">=</span> <span class="s1">&#39;../experiments/tutorial/tutorial.yml&#39;</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">create_lstm_model</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;model_config&#39;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;weights_file&#39;</span><span class="p">],</span> <span class="n">map_location</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DTYPE</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sequential(
  (0): LSTM(5, 128, batch_first=True)
  (1): LSTMOutput()
  (2): Linear(in_features=128, out_features=1, bias=True)
  (3): LeakyReLU(negative_slope=0.01)
)
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-plumbing-for-model-inference">
<h2>Data plumbing for model inference<a class="headerlink" href="#data-plumbing-for-model-inference" title="Permalink to this heading">#</a></h2>
<p>We expect you’re getting excited at this point to see how the trained model performs, but the unfortunate reality of using deep-learning models means that there is often a rift between training and application data workflows. In our case it’s not to onerous, but it does require a little bit of work to be most efficient. As always, we just want to open the data up as a first step, and we can reuse previous data processing functions to get there.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">merge_data</span><span class="p">()</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">select_region</span><span class="p">(</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_config&#39;</span><span class="p">][</span><span class="s1">&#39;test_period&#39;</span><span class="p">]),</span>
    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_config&#39;</span><span class="p">][</span><span class="s1">&#39;regions&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Beyond that, we don’t wan’t to filter out missing data because that would mean we have ragged arrays that need complex logic to reconstruct. Instead we can just fill missing data. On one hand, this might seem like a hack simply to reduce the number of lines of code, but on the other is actually a nice optimization because of how fast these types of trained models can run compared to actually solving differential equations. That is, it’s easier to run a forward pass on some irrelevant data than it is to activiely filter out the missing regions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">true_mask</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># Make sure to make sure nans are not in the mask</span>
<span class="n">true_mask</span> <span class="o">=</span> <span class="n">true_mask</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, with the “filled” data, we want to make sure that we record the actual dimensions of the data as a tuple of <code class="docutils literal notranslate"><span class="pre">(lat,</span> <span class="pre">lon,</span> <span class="pre">time)</span></code> so that we can reconstruct things later.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">actual_shape</span> <span class="o">=</span> <span class="p">(</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]),</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">]),</span>
    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_config&#39;</span><span class="p">][</span><span class="s1">&#39;output_sequence_length&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can record the dimensions that we’ll iterate over in place of the ones that we used at train time. What we are doing here is simply setting the <code class="docutils literal notranslate"><span class="pre">batch_dims</span></code> keyword that will go into the <code class="docutils literal notranslate"><span class="pre">make_data_pipeline</span></code> function that we developed in the <code class="docutils literal notranslate"><span class="pre">datapipes</span></code> module. Effectively all this says is to run the full domain on every forward pass of the network.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_config&#39;</span><span class="p">][</span><span class="s1">&#39;batch_dims&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">])</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>And finally, we make the data pipeline with our same old <code class="docutils literal notranslate"><span class="pre">make_data_pipeline</span></code> function. We set a few extra parameters like <code class="docutils literal notranslate"><span class="pre">min_samples=0</span></code> so we don’t filter anywhere out, <code class="docutils literal notranslate"><span class="pre">preload=True</span></code> so we load the data automatically to save computational cost, and <code class="docutils literal notranslate"><span class="pre">filter_mask=False</span></code> to include data outside of the masked region in order to make spatiotemporally complete predictions. The rest of the configuration comes from what we recorded in the <code class="docutils literal notranslate"><span class="pre">config</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">make_data_pipeline</span><span class="p">(</span>
    <span class="n">ds</span><span class="o">=</span><span class="n">test_data</span><span class="p">,</span> 
    <span class="n">min_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
    <span class="n">preload</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">filter_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_config&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="running-the-model-in-forward-inference-mode">
<h2>Running the model in forward/inference mode<a class="headerlink" href="#running-the-model-in-forward-inference-mode" title="Permalink to this heading">#</a></h2>
<p>Given this, we are ready to actually run our trained model on the testing dataset. For this we’ll loop over the new <code class="docutils literal notranslate"><span class="pre">pipe</span></code> object. For every element in the data pipe we can simply transfer it onto the <code class="docutils literal notranslate"><span class="pre">DEVICE</span></code> and run it through the model. In the process we have specified <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">torch.no_grad()</span></code> which ensures that we do not run the backwards pass on the model, saving computation. We also make sure to transfer the predictions back onto the CPU from whatever <code class="docutils literal notranslate"><span class="pre">DEVICE</span></code> they were run on and finally reshape everything back into the correct shape, which basically unflattens things so that the spatial relations are recovered.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">pipe</span><span class="p">)):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DTYPE</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">yhat</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">yhat</span> <span class="o">=</span> <span class="n">yhat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">actual_shape</span><span class="p">)</span>
    <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a45c83f85e5649bbb872f88da4dba47e", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="putting-the-data-back-together">
<h2>Putting the data back together<a class="headerlink" href="#putting-the-data-back-together" title="Permalink to this heading">#</a></h2>
<p>With the above cell we’ve done most of the work, but it’s often convenient to repackage the resulting predictions from a stack of numpy arrays into an xarray Dataset so that we can easily locate the data in time/space coordinates that are easily interpreted by humans. To do so we can simply make use of the “coordinates” from the truth/reference dataset from ERA5.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_config&#39;</span><span class="p">][</span><span class="s1">&#39;input_overlap&#39;</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> 
<span class="n">swe_true</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;swe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">))</span>

<span class="n">swe_pred</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span>
    <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">),</span> <span class="n">coords</span> <span class="o">=</span> <span class="n">swe_true</span><span class="o">.</span><span class="n">coords</span>
<span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<p>Finally, we need to undo our scaling from earlier. We know that we used a “standardization” method to subtract of the mean and divide by the standard deviation of the cubed root of the SWE for training. Ideally this would be recorded by your MLOps framework, but for our narrow use case, we can just undo this by hand here. What comes out is our overall SWE predictions for the test period!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_var</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_config&#39;</span><span class="p">][</span><span class="s1">&#39;output_vars&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">scale_means</span><span class="p">[</span><span class="n">target_var</span><span class="p">]</span>
<span class="n">sig</span> <span class="o">=</span> <span class="n">scale_stds</span><span class="p">[</span><span class="n">target_var</span><span class="p">]</span>
<span class="n">swe_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">swe_pred</span> <span class="o">*</span> <span class="n">sig</span><span class="p">)</span> <span class="o">+</span><span class="n">mu</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
<span class="n">swe_pred</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.DataArray (lat: 65, lon: 100, time: 2220)&gt;
array([[[ 4.92740762e-03,  4.23133883e-03,  5.05575629e-03, ...,
          3.72598697e-03,  3.65601723e-03,  4.27942177e-03],
        [ 4.99130692e-03,  4.07989615e-03,  4.82212473e-03, ...,
          3.58692899e-03,  3.44301780e-03,  4.03332245e-03],
        [ 5.03421191e-03,  3.99631972e-03,  4.74932610e-03, ...,
          3.25451464e-03,  2.99626252e-03,  3.56979400e-03],
        ...,
        [ 1.60430150e-03,  1.56448614e-03,  1.57933876e-03, ...,
          2.00094208e-02,  2.29498101e-02,  2.30683115e-02],
        [ 1.59428508e-03,  1.55463631e-03,  1.58431044e-03, ...,
          1.99554871e-02,  2.27728201e-02,  2.33663480e-02],
        [ 1.51082349e-03,  1.42104902e-03,  1.43964485e-03, ...,
          2.18442237e-02,  2.47704067e-02,  2.53347742e-02]],

       [[ 3.52719548e-03,  2.93578472e-03,  3.65601723e-03, ...,
          2.95082714e-03,  2.60376579e-03,  2.99626252e-03],
        [ 3.47652626e-03,  2.63158852e-03,  3.21446774e-03, ...,
          2.82459280e-03,  2.49443589e-03,  2.91331708e-03],
        [ 3.31113708e-03,  2.36213340e-03,  2.91331708e-03, ...,
          2.42107490e-03,  2.09369790e-03,  2.56240048e-03],
...
        [-2.84040077e-12, -4.97982626e-15,  2.19286056e-04, ...,
          7.53456989e-05,  1.46649778e-04,  1.18136431e-03],
        [-2.97749022e-11, -2.86487510e-13,  1.11254820e-04, ...,
         -1.16756716e-16,  1.68456609e-05,  7.73541629e-04],
        [-5.95609997e-11, -1.36953273e-11,  1.24764483e-05, ...,
         -1.99205663e-11,  1.34765287e-07,  3.88985776e-04]],

       [[            nan,             nan,             nan, ...,
                     nan,             nan,             nan],
        [            nan,             nan,             nan, ...,
                     nan,             nan,             nan],
        [            nan,             nan,             nan, ...,
                     nan,             nan,             nan],
        ...,
        [-3.30078787e-12, -9.30640620e-13,  6.65647676e-05, ...,
          4.62244934e-05,  1.16415322e-04,  1.02510962e-03],
        [-3.50011747e-11, -5.90239001e-12,  2.98078958e-05, ...,
         -7.15490175e-14,  1.20865880e-05,  7.04713764e-04],
        [-7.79891707e-11, -4.16594475e-11,  3.92901711e-07, ...,
         -3.50011747e-11,  1.45519152e-11,  3.19443643e-04]]])
Coordinates:
  * lat      (lat) float32 50.0 49.75 49.5 49.25 49.0 ... 34.75 34.5 34.25 34.0
  * lon      (lon) float32 230.2 230.5 230.8 231.0 ... 254.2 254.5 254.8 255.0
  * time     (time) datetime64[ns] 2008-11-26 2008-11-27 ... 2014-12-24</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.DataArray</div><div class='xr-array-name'></div><ul class='xr-dim-list'><li><span class='xr-has-index'>lat</span>: 65</li><li><span class='xr-has-index'>lon</span>: 100</li><li><span class='xr-has-index'>time</span>: 2220</li></ul></div><ul class='xr-sections'><li class='xr-section-item'><div class='xr-array-wrap'><input id='section-88efff10-03f0-4d71-9311-7c23b721558c' class='xr-array-in' type='checkbox' checked><label for='section-88efff10-03f0-4d71-9311-7c23b721558c' title='Show/hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-array-preview xr-preview'><span>0.004927 0.004231 0.005056 0.004338 ... -3.5e-11 1.455e-11 0.0003194</span></div><div class='xr-array-data'><pre>array([[[ 4.92740762e-03,  4.23133883e-03,  5.05575629e-03, ...,
          3.72598697e-03,  3.65601723e-03,  4.27942177e-03],
        [ 4.99130692e-03,  4.07989615e-03,  4.82212473e-03, ...,
          3.58692899e-03,  3.44301780e-03,  4.03332245e-03],
        [ 5.03421191e-03,  3.99631972e-03,  4.74932610e-03, ...,
          3.25451464e-03,  2.99626252e-03,  3.56979400e-03],
        ...,
        [ 1.60430150e-03,  1.56448614e-03,  1.57933876e-03, ...,
          2.00094208e-02,  2.29498101e-02,  2.30683115e-02],
        [ 1.59428508e-03,  1.55463631e-03,  1.58431044e-03, ...,
          1.99554871e-02,  2.27728201e-02,  2.33663480e-02],
        [ 1.51082349e-03,  1.42104902e-03,  1.43964485e-03, ...,
          2.18442237e-02,  2.47704067e-02,  2.53347742e-02]],

       [[ 3.52719548e-03,  2.93578472e-03,  3.65601723e-03, ...,
          2.95082714e-03,  2.60376579e-03,  2.99626252e-03],
        [ 3.47652626e-03,  2.63158852e-03,  3.21446774e-03, ...,
          2.82459280e-03,  2.49443589e-03,  2.91331708e-03],
        [ 3.31113708e-03,  2.36213340e-03,  2.91331708e-03, ...,
          2.42107490e-03,  2.09369790e-03,  2.56240048e-03],
...
        [-2.84040077e-12, -4.97982626e-15,  2.19286056e-04, ...,
          7.53456989e-05,  1.46649778e-04,  1.18136431e-03],
        [-2.97749022e-11, -2.86487510e-13,  1.11254820e-04, ...,
         -1.16756716e-16,  1.68456609e-05,  7.73541629e-04],
        [-5.95609997e-11, -1.36953273e-11,  1.24764483e-05, ...,
         -1.99205663e-11,  1.34765287e-07,  3.88985776e-04]],

       [[            nan,             nan,             nan, ...,
                     nan,             nan,             nan],
        [            nan,             nan,             nan, ...,
                     nan,             nan,             nan],
        [            nan,             nan,             nan, ...,
                     nan,             nan,             nan],
        ...,
        [-3.30078787e-12, -9.30640620e-13,  6.65647676e-05, ...,
          4.62244934e-05,  1.16415322e-04,  1.02510962e-03],
        [-3.50011747e-11, -5.90239001e-12,  2.98078958e-05, ...,
         -7.15490175e-14,  1.20865880e-05,  7.04713764e-04],
        [-7.79891707e-11, -4.16594475e-11,  3.92901711e-07, ...,
         -3.50011747e-11,  1.45519152e-11,  3.19443643e-04]]])</pre></div></div></li><li class='xr-section-item'><input id='section-44f4ef42-6d2f-43c1-b370-2d340ec1f1b0' class='xr-section-summary-in' type='checkbox'  checked><label for='section-44f4ef42-6d2f-43c1-b370-2d340ec1f1b0' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>lat</span></div><div class='xr-var-dims'>(lat)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>50.0 49.75 49.5 ... 34.5 34.25 34.0</div><input id='attrs-ba2c2919-38e5-43e6-a067-06173baa611e' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-ba2c2919-38e5-43e6-a067-06173baa611e' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-42c3023e-c10c-41bb-ade4-1519a8612e39' class='xr-var-data-in' type='checkbox'><label for='data-42c3023e-c10c-41bb-ade4-1519a8612e39' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>latitude</dd><dt><span>units :</span></dt><dd>degrees_north</dd></dl></div><div class='xr-var-data'><pre>array([50.  , 49.75, 49.5 , 49.25, 49.  , 48.75, 48.5 , 48.25, 48.  , 47.75,
       47.5 , 47.25, 47.  , 46.75, 46.5 , 46.25, 46.  , 45.75, 45.5 , 45.25,
       45.  , 44.75, 44.5 , 44.25, 44.  , 43.75, 43.5 , 43.25, 43.  , 42.75,
       42.5 , 42.25, 42.  , 41.75, 41.5 , 41.25, 41.  , 40.75, 40.5 , 40.25,
       40.  , 39.75, 39.5 , 39.25, 39.  , 38.75, 38.5 , 38.25, 38.  , 37.75,
       37.5 , 37.25, 37.  , 36.75, 36.5 , 36.25, 36.  , 35.75, 35.5 , 35.25,
       35.  , 34.75, 34.5 , 34.25, 34.  ], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>lon</span></div><div class='xr-var-dims'>(lon)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>230.2 230.5 230.8 ... 254.8 255.0</div><input id='attrs-f0878136-6f85-4d69-9e32-bac6810dd81b' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-f0878136-6f85-4d69-9e32-bac6810dd81b' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-d582bc8e-f9b0-4bf6-910c-c378abd8e97f' class='xr-var-data-in' type='checkbox'><label for='data-d582bc8e-f9b0-4bf6-910c-c378abd8e97f' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>longitude</dd><dt><span>units :</span></dt><dd>degrees_east</dd></dl></div><div class='xr-var-data'><pre>array([230.25, 230.5 , 230.75, 231.  , 231.25, 231.5 , 231.75, 232.  , 232.25,
       232.5 , 232.75, 233.  , 233.25, 233.5 , 233.75, 234.  , 234.25, 234.5 ,
       234.75, 235.  , 235.25, 235.5 , 235.75, 236.  , 236.25, 236.5 , 236.75,
       237.  , 237.25, 237.5 , 237.75, 238.  , 238.25, 238.5 , 238.75, 239.  ,
       239.25, 239.5 , 239.75, 240.  , 240.25, 240.5 , 240.75, 241.  , 241.25,
       241.5 , 241.75, 242.  , 242.25, 242.5 , 242.75, 243.  , 243.25, 243.5 ,
       243.75, 244.  , 244.25, 244.5 , 244.75, 245.  , 245.25, 245.5 , 245.75,
       246.  , 246.25, 246.5 , 246.75, 247.  , 247.25, 247.5 , 247.75, 248.  ,
       248.25, 248.5 , 248.75, 249.  , 249.25, 249.5 , 249.75, 250.  , 250.25,
       250.5 , 250.75, 251.  , 251.25, 251.5 , 251.75, 252.  , 252.25, 252.5 ,
       252.75, 253.  , 253.25, 253.5 , 253.75, 254.  , 254.25, 254.5 , 254.75,
       255.  ], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>2008-11-26 ... 2014-12-24</div><input id='attrs-d925fba1-827d-413f-bbf2-5d29996e3ecd' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-d925fba1-827d-413f-bbf2-5d29996e3ecd' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-94711be8-3447-4230-a4c1-04831eb3cb66' class='xr-var-data-in' type='checkbox'><label for='data-94711be8-3447-4230-a4c1-04831eb3cb66' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;2008-11-26T00:00:00.000000000&#x27;, &#x27;2008-11-27T00:00:00.000000000&#x27;,
       &#x27;2008-11-28T00:00:00.000000000&#x27;, ..., &#x27;2014-12-22T00:00:00.000000000&#x27;,
       &#x27;2014-12-23T00:00:00.000000000&#x27;, &#x27;2014-12-24T00:00:00.000000000&#x27;],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-ad613a96-1def-492e-8a92-e808adcfb097' class='xr-section-summary-in' type='checkbox'  ><label for='section-ad613a96-1def-492e-8a92-e808adcfb097' class='xr-section-summary' >Indexes: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>lat</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-de527f72-71c6-4293-9964-ae076ff73d0c' class='xr-index-data-in' type='checkbox'/><label for='index-de527f72-71c6-4293-9964-ae076ff73d0c' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([ 50.0, 49.75,  49.5, 49.25,  49.0, 48.75,  48.5, 48.25,  48.0,
              47.75,  47.5, 47.25,  47.0, 46.75,  46.5, 46.25,  46.0, 45.75,
               45.5, 45.25,  45.0, 44.75,  44.5, 44.25,  44.0, 43.75,  43.5,
              43.25,  43.0, 42.75,  42.5, 42.25,  42.0, 41.75,  41.5, 41.25,
               41.0, 40.75,  40.5, 40.25,  40.0, 39.75,  39.5, 39.25,  39.0,
              38.75,  38.5, 38.25,  38.0, 37.75,  37.5, 37.25,  37.0, 36.75,
               36.5, 36.25,  36.0, 35.75,  35.5, 35.25,  35.0, 34.75,  34.5,
              34.25,  34.0],
             dtype=&#x27;float64&#x27;, name=&#x27;lat&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>lon</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-4074f699-e7f0-47e2-bb1f-51d149f0beb7' class='xr-index-data-in' type='checkbox'/><label for='index-4074f699-e7f0-47e2-bb1f-51d149f0beb7' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([230.25,  230.5, 230.75,  231.0, 231.25,  231.5, 231.75,  232.0,
              232.25,  232.5, 232.75,  233.0, 233.25,  233.5, 233.75,  234.0,
              234.25,  234.5, 234.75,  235.0, 235.25,  235.5, 235.75,  236.0,
              236.25,  236.5, 236.75,  237.0, 237.25,  237.5, 237.75,  238.0,
              238.25,  238.5, 238.75,  239.0, 239.25,  239.5, 239.75,  240.0,
              240.25,  240.5, 240.75,  241.0, 241.25,  241.5, 241.75,  242.0,
              242.25,  242.5, 242.75,  243.0, 243.25,  243.5, 243.75,  244.0,
              244.25,  244.5, 244.75,  245.0, 245.25,  245.5, 245.75,  246.0,
              246.25,  246.5, 246.75,  247.0, 247.25,  247.5, 247.75,  248.0,
              248.25,  248.5, 248.75,  249.0, 249.25,  249.5, 249.75,  250.0,
              250.25,  250.5, 250.75,  251.0, 251.25,  251.5, 251.75,  252.0,
              252.25,  252.5, 252.75,  253.0, 253.25,  253.5, 253.75,  254.0,
              254.25,  254.5, 254.75,  255.0],
             dtype=&#x27;float64&#x27;, name=&#x27;lon&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>time</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-ee84c101-958a-4d2f-adb7-be5e83bda175' class='xr-index-data-in' type='checkbox'/><label for='index-ee84c101-958a-4d2f-adb7-be5e83bda175' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(DatetimeIndex([&#x27;2008-11-26&#x27;, &#x27;2008-11-27&#x27;, &#x27;2008-11-28&#x27;, &#x27;2008-11-29&#x27;,
               &#x27;2008-11-30&#x27;, &#x27;2008-12-01&#x27;, &#x27;2008-12-02&#x27;, &#x27;2008-12-03&#x27;,
               &#x27;2008-12-04&#x27;, &#x27;2008-12-05&#x27;,
               ...
               &#x27;2014-12-15&#x27;, &#x27;2014-12-16&#x27;, &#x27;2014-12-17&#x27;, &#x27;2014-12-18&#x27;,
               &#x27;2014-12-19&#x27;, &#x27;2014-12-20&#x27;, &#x27;2014-12-21&#x27;, &#x27;2014-12-22&#x27;,
               &#x27;2014-12-23&#x27;, &#x27;2014-12-24&#x27;],
              dtype=&#x27;datetime64[ns]&#x27;, name=&#x27;time&#x27;, length=2220, freq=None))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-513f5a8b-fcd6-4f14-871c-7b2f0dee4865' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-513f5a8b-fcd6-4f14-871c-7b2f0dee4865' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div></div>
</div>
</section>
<section id="getting-to-the-analysis-and-quantifying-model-performance">
<h2>Getting to the analysis and quantifying model performance<a class="headerlink" href="#getting-to-the-analysis-and-quantifying-model-performance" title="Permalink to this heading">#</a></h2>
<p>At this point we’ve assembled all of the predictions and reference data into similar data formats and all that’s left for us to do is some analysis. Model analysis very problem and domain specific, but we will cover some basic analytics on our model here. First, if you have applied your model to the <code class="docutils literal notranslate"><span class="pre">WNA</span></code>, or Western North America region, you will see we’ve picked out some individual regions to look at individual timeseries on the spatial averages. These include major portions of prominent mountain ranges such as the Southern Rocky Mountains, Northern Cascade Mountains, and Central Sierra Nevada Mountains.</p>
<p>First, looking at the Southern Rockies we see our model performs quite well in both timing and magnitude! That’s quite exciting given we’ve spent very little actual time training the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">38</span><span class="p">),</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">252</span><span class="p">,</span> <span class="mi">254</span><span class="p">),</span> <span class="p">}</span>
<span class="n">swe_true</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">loc</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;ERA5&#39;</span><span class="p">)</span>
<span class="n">swe_pred</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">loc</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;LSTM&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Southern Rockies&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;SWE [m]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f1259f01eb0&gt;
</pre></div>
</div>
<img alt="_images/594f15a4f6f13a8a5e0e769fb98e20ff69cfb40dda0958d44248f33a884f89cc.png" src="_images/594f15a4f6f13a8a5e0e769fb98e20ff69cfb40dda0958d44248f33a884f89cc.png" />
</div>
</div>
<p>As for the Northern Cascades, we see good agreement in the timing, but a bit of underprediction. You may note that these values are quite a bit higher than the Southern Rockies, and this is part of the reason our model does not capture the magnitude as well. LSTMs, and deep learning models generally, tend to do worse on the extreme values and here is no different. If you trained the model further these would probably be captured better. Still, this is a very good looking model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">49</span><span class="p">,</span> <span class="mi">47</span><span class="p">),</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">238</span><span class="p">,</span> <span class="mi">240</span><span class="p">),</span> <span class="p">}</span>
<span class="n">swe_true</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">loc</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;ERA5&#39;</span><span class="p">)</span>
<span class="n">swe_pred</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">loc</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;LSTM&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Northern Cascades&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;SWE [m]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f1285c60bb0&gt;
</pre></div>
</div>
<img alt="_images/0955458d77649d03be0b5df436e49849da1633a05b52ef077cb78e1d9fa264c9.png" src="_images/0955458d77649d03be0b5df436e49849da1633a05b52ef077cb78e1d9fa264c9.png" />
</div>
</div>
<p>Finally, let’s check out results from the Central Sierra Nevada mountains. This particular location has significantly less snow than the Northern Cascades, and even has some low snow years to compare to. From this we can see that the model does quite well with the low snow years, showing strong robustness across different snow regimes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mf">38.5</span><span class="p">,</span> <span class="mf">37.5</span><span class="p">),</span> <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mf">239.75</span><span class="p">,</span> <span class="mf">240.25</span><span class="p">),</span> <span class="p">}</span>
<span class="n">loc_swe_true</span> <span class="o">=</span> <span class="n">swe_true</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">loc</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span>
<span class="n">loc_swe_true</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;ERA5&#39;</span><span class="p">)</span>
<span class="n">loc_swe_pred</span> <span class="o">=</span> <span class="n">swe_pred</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="o">**</span><span class="n">loc</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span>
<span class="n">loc_swe_pred</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;LSTM&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Central Sierra Nevada&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;SWE [m]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f12602123d0&gt;
</pre></div>
</div>
<img alt="_images/49cd0c65c772ec165f1ad2908bdcf3751e16d3fd423c2af48770d97b857c115d.png" src="_images/49cd0c65c772ec165f1ad2908bdcf3751e16d3fd423c2af48770d97b857c115d.png" />
</div>
</div>
<p>The individual SWE traces looked quite good for all of the regions, but the next question to ask is how does the model fare spatially? We will look into this by looking at the peak SWE for about a year’s worth of time. First, let’s look at the target values, and note the non-linear color scale. The spatial patterns are as expected, with higher snow in the major mountain ranges, and less in low-lying areas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">peak_swe</span> <span class="o">=</span> <span class="n">swe_true</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">peak_swe</span> <span class="o">=</span> <span class="n">peak_swe</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">true_mask</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">peak_swe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">PowerNorm</span><span class="p">(</span><span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.9</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;turbo&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peak SWE (ERA5)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Peak SWE (ERA5)&#39;)
</pre></div>
</div>
<img alt="_images/2d6fae50d55f450be0c2a493f1e4e88bfeb8fecb76c374e1e10fb16830b627a9.png" src="_images/2d6fae50d55f450be0c2a493f1e4e88bfeb8fecb76c374e1e10fb16830b627a9.png" />
</div>
</div>
<p>But how does it compare with the peak SWE from our model over the same time period? From the eye, quite well! Below you see these results, and most people would be hard pressed to point out major divergences.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">peak_swe</span> <span class="o">=</span> <span class="n">swe_pred</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">peak_swe</span> <span class="o">=</span> <span class="n">peak_swe</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">true_mask</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">peak_swe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">PowerNorm</span><span class="p">(</span><span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.9</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;turbo&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Peak SWE (LSTM)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Peak SWE (LSTM)&#39;)
</pre></div>
</div>
<img alt="_images/37c8d0e9e60d022f46554f858f7ba1e48bab65fb3d932bc5122c50bf6086aac7.png" src="_images/37c8d0e9e60d022f46554f858f7ba1e48bab65fb3d932bc5122c50bf6086aac7.png" />
</div>
</div>
<p>To zoom in a bit better on where model differences crop up, let’s also look at an error plot for the two calculations. Overall, we see mostly errors in the mountainous regions where snow predictions are higher, which is in line with what we saw from the timeseries plots and common sense. Overally, the SWE along the coastal regions such as the western slopes of the Cascades and Sierra Nevada mountains are where we have the highest error. It’s difficult to say whether this is a structural error in our model/data without training more robustly, but eoverall these results are quite impressive given how much computation muscle we’ve thrown at the problem!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">delta_peak_swe</span> <span class="o">=</span> <span class="p">(</span><span class="n">swe_true</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
                  <span class="o">-</span> <span class="n">swe_pred</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">))</span>
<span class="n">delta_peak_swe</span> <span class="o">=</span> <span class="n">delta_peak_swe</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">true_mask</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">delta_peak_swe</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Spectral&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Difference in peak SWE (ERA5-LSTM)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Difference in peak SWE (ERA5-LSTM)&#39;)
</pre></div>
</div>
<img alt="_images/dddf00d2b8ff7ac1e1224f754bab216798bc35f2e852b75abc2537493dd0d1a9.png" src="_images/dddf00d2b8ff7ac1e1224f754bab216798bc35f2e852b75abc2537493dd0d1a9.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-notebook-py"
        },
        kernelOptions: {
            name: "conda-env-notebook-py",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-notebook-py'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="2_model_training.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Tutorial 2: Implementing the model and training pipeline</p>
      </div>
    </a>
    <a class="right-next"
       href="4_application_on_climate_projections.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Tutorial 4: Running the model on downscaled climate projections</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outline">Outline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-and-configuration">Setup and configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-the-setup-from-our-saved-experiment">Loading the setup from our saved experiment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-plumbing-for-model-inference">Data plumbing for model inference</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-model-in-forward-inference-mode">Running the model in forward/inference mode</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#putting-the-data-back-together">Putting the data back together</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-to-the-analysis-and-quantifying-model-performance">Getting to the analysis and quantifying model performance</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By eScience Institute, University of Washington
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>